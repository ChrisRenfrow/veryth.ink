---
import { type CollectionEntry } from 'astro:content'

import FormattedDate from '@components/FormattedDate.astro'
import Toc from '@components/Toc.astro'
import BaseLayout from '@layouts/BaseLayout.astro'
import { getAllPosts } from '~/helpers/queries'
import { slugify } from '~/helpers/utils'

export async function getStaticPaths() {
  const posts: CollectionEntry<'blog'>[] = await getAllPosts()

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}

interface Props {
  post: CollectionEntry<'blog'>
}

const { post } = Astro.props
const { Content, headings } = await post.render()

const shallowHeadings = headings.filter((h) => h.depth <= 2)
const hasHeadings = headings.length > 0
const hasCategory = !!post.data.category
const hasTags = !!post.data.tags
---

<BaseLayout>
  <article class="pb-6">
    <header class="flex flex-col space-y-2 pb-2">
      <h1 class="text-4xl font-bold lowercase">{post.data.title}</h1>
      <div class="flex flex-row gap-4 md:flex-col">
        <time class="font-bold"
          ><FormattedDate date={post.data.published_on} /></time
        >
        {
          hasCategory && (
            <span>
              <a
                class="text-stone-500 underline decoration-stone-400 hover:bg-stone-600 hover:text-stone-200 hover:no-underline"
                href={`/blog/categories/${post.data.category}`}
              >
                /{post.data.category}
              </a>
            </span>
          )
        }
      </div>
      <p class="text-lg text-stone-600 dark:text-stone-400">
        {post.data.description}
      </p>
      <div class="ml-auto mt-auto lowercase">by {post.data.author}</div>
    </header>
    <hr class="border-orange-700" />
  </article>
  <main>
    <aside
      class:list={['hidden', 'md:block', headings.length == 0 && 'hidden']}
    >
      {
        hasHeadings && (
          <nav class="float-right min-w-56 pb-4 pl-8">
            <h3 class="font-bold">contents</h3>
            <hr class="border-stone-400 pb-4" />
            <Toc headings={shallowHeadings} />
          </nav>
        )
      }
    </aside>
    <section
      class="light:prose-h1:text-stone-200 prose prose-stone !max-w-none dark:prose-invert prose-headings:font-bold prose-headings:lowercase prose-headings:underline prose-h1:text-2xl prose-p:text-justify prose-a:decoration-orange-600 prose-a:decoration-2 hover:prose-a:bg-orange-600 hover:prose-a:text-stone-800 prose-blockquote:border-stone-600 marker:prose-ul:text-stone-600"
    >
      <Content />
    </section>
  </main>
  {
    hasTags && (
      <footer class="pt-5">
        <nav class="inline-flex flex-wrap gap-1">
          {post.data.tags &&
            post.data.tags.map((tag: string) => {
              const slugTag = slugify(tag)
              // prettier-ignore
              return (
                <span class="after:content-[','] last:after:content-none">
                <a class="text-orange-600 hover:bg-orange-600 hover:text-stone-800" href={`/blog/tags/${slugTag}`}>#{slugTag}</a></span>
              )
            })}
        </nav>
      </footer>
    )
  }
</BaseLayout>
