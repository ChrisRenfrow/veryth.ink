---
import BaseLayout from '@layouts/BaseLayout.astro'
import FormattedDate from '@components/FormattedDate.astro'
import type { GetStaticPaths } from 'astro'
import { slugify } from '~/helpers/utils'
import { getAllProjects } from '~/helpers/queries'
import { getAllPosts } from '~/helpers/queries'

// Project page layout:
// Title + other statistics (started, # of stars, status, etc.)
// Brief description
// List of posts associated to the project (if any)

export const getStaticPaths = (async () => {
  const projects = await getAllProjects()
  const allPosts = await getAllPosts()

  return projects.map((project) => {
    const relatedPosts = allPosts.filter((post) =>
      project.relationalTags?.some((tag) => post.data.tags?.includes(tag)),
    )
    return {
      params: { slug: project.slug },
      props: { project, posts: relatedPosts },
    }
  })
}) satisfies GetStaticPaths

const { project, posts } = Astro.props
const { Content } = await project.render()

const {
  name,
  description,
  body,
  homepage,
  repository,
  dateStarted,
  dateFinished,
  status,
  contributors,
} = project.data
---

<BaseLayout>
  <article class="pb-6">
    <header class="flex flex-col space-y-2 pb-2">
      <h1 class="text-4xl font-bold lowercase">{name}</h1>
      <p class="text-lg text-stone-600 dark:text-stone-400">{description}</p>
    </header>
    <hr class="border-orange-700" />
  </article>
  <main>
    <section
      class="prose prose-stone !max-w-none dark:prose-invert prose-headings:font-bold prose-headings:lowercase prose-headings:underline prose-h2:text-2xl prose-p:text-justify"
    >
      <h2>About</h2>
      <p><Content /></p>
    </section>

    <section class="mt-6">
      <h2 class="text-2xl font-bold lowercase underline">Details</h2>
      <ul class="mt-2 space-y-1">
        <li><span class="font-bold">Status:</span> {status}</li>
        <li
          ><span class="font-bold">Started:</span>
          <FormattedDate date={dateStarted} /></li
        >
        {
          dateFinished && (
            <li>
              <span class="font-bold">Finished:</span>{' '}
              <FormattedDate date={dateFinished} />
            </li>
          )
        }
        {
          homepage && (
            <li>
              <span class="font-bold">Homepage:</span>{' '}
              <a
                href={homepage}
                class="text-orange-600 hover:bg-orange-600 hover:text-stone-800"
              >
                {homepage}
              </a>
            </li>
          )
        }
        {
          repository && (
            <li>
              <span class="font-bold">Repository:</span>{' '}
              <a
                href={repository}
                class="text-orange-600 hover:bg-orange-600 hover:text-stone-800"
              >
                {repository}
              </a>
            </li>
          )
        }
      </ul>
    </section>

    {
      contributors && (
        <section class="mt-6">
          <h2 class="text-2xl font-bold lowercase underline">Contributors</h2>
          <ul class="mt-2 space-y-1">
            {contributors.map((contributor) => (
              <li>
                {contributor.name}{' '}
                <a
                  href={`https://github.com/${contributor.github}`}
                  class="text-orange-600 hover:bg-orange-600 hover:text-stone-800"
                >
                  @{contributor.github}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )
    }

    {
      posts && posts.length > 0 && (
        <section class="mt-6">
          <h2 class="text-2xl font-bold lowercase underline">Related Posts</h2>
          <PostList posts={posts} />
          {project.relationalTags && project.relationalTags.length > 0 && (
            <div class="mt-4">
              <a
                href={`/blog/tags/${project.relationalTags[0]}`}
                class="inline-block rounded bg-orange-600 px-4 py-2 text-white hover:bg-orange-700"
              >
                More Posts
              </a>
            </div>
          )}
        </section>
      )
    }
  </main>
</BaseLayout>
